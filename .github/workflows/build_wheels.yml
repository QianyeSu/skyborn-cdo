# ===========================================================================
# skyborn-cdo: Build and publish pre-compiled CDO wheels
# ===========================================================================
# Builds CDO (Climate Data Operators) from source along with all its
# dependencies (NetCDF, HDF5, ecCodes, FFTW3, PROJ, UDUNITS2) and packages
# them into platform-specific Python wheels.
#
# Supported platforms:
#   - Linux x86_64 (manylinux_2_28)
#   - macOS arm64 (Apple Silicon, macOS 11.0+)
#   - Windows x86_64 (MSYS2/MinGW64)
#
# Triggers:
#   - Push to main branch
#   - Pull requests
#   - Release tags (v*)
# ===========================================================================

name: Build CDO Wheels

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =========================================================================
  # Linux x86_64
  # =========================================================================
  build_linux_x86_64:
    name: Linux x86_64
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install cibuildwheel
        run: pip install cibuildwheel==2.22.0

      - name: Build wheels
        run: python -m cibuildwheel --output-dir wheelhouse
        env:
          CIBW_BUILD: "cp39-manylinux_x86_64 cp310-manylinux_x86_64 cp311-manylinux_x86_64 cp312-manylinux_x86_64 cp313-manylinux_x86_64"
          CIBW_MANYLINUX_X86_64_IMAGE: manylinux_2_28
          CIBW_BEFORE_ALL_LINUX: >
            bash {project}/scripts/build_deps_linux.sh &&
            bash {project}/scripts/build_cdo.sh
          CIBW_ENVIRONMENT_LINUX: >
            SKYBORN_CDO_BUILD=0
            CDO_DEPS_PREFIX=/opt/cdo-deps
            CDO_INSTALL_PREFIX=/opt/cdo-install
          CIBW_BEFORE_BUILD_LINUX: >
            mkdir -p {project}/src/skyborn_cdo/bin &&
            cp /opt/cdo-install/bin/cdo {project}/src/skyborn_cdo/bin/ &&
            chmod +x {project}/src/skyborn_cdo/bin/cdo &&
            mkdir -p {project}/src/skyborn_cdo/lib &&
            (cp -a /opt/cdo-deps/lib/*.so* {project}/src/skyborn_cdo/lib/ 2>/dev/null || true) &&
            (cp -a /opt/cdo-deps/lib64/*.so* {project}/src/skyborn_cdo/lib/ 2>/dev/null || true) &&
            (cp -a /opt/cdo-install/lib/*.so* {project}/src/skyborn_cdo/lib/ 2>/dev/null || true) &&
            mkdir -p {project}/src/skyborn_cdo/share &&
            (cp -r /opt/cdo-deps/share/proj {project}/src/skyborn_cdo/share/ 2>/dev/null || true) &&
            (cp -r /opt/cdo-deps/share/udunits {project}/src/skyborn_cdo/share/ 2>/dev/null || true) &&
            find {project}/src/skyborn_cdo/share/proj/ -type f ! -name 'proj.db' -delete 2>/dev/null || true &&
            strip --strip-unneeded {project}/src/skyborn_cdo/bin/cdo 2>/dev/null || true &&
            find {project}/src/skyborn_cdo/lib/ -name '*.so*' -exec strip --strip-unneeded {} + 2>/dev/null || true &&
            echo '=== Packaging size check ===' &&
            du -sh {project}/src/skyborn_cdo/bin/ {project}/src/skyborn_cdo/lib/ {project}/src/skyborn_cdo/share/ 2>/dev/null || true &&
            ls -la {project}/src/skyborn_cdo/bin/
          CIBW_REPAIR_WHEEL_COMMAND_LINUX: >
            LD_LIBRARY_PATH=/opt/cdo-deps/lib:/opt/cdo-deps/lib64:/opt/cdo-install/lib
            auditwheel repair -w {dest_dir} {wheel}
          CIBW_TEST_COMMAND: >
            python -c "from skyborn_cdo import Cdo; import tempfile, os; cdo = Cdo(); tmpdir = tempfile.mkdtemp(); grb = os.path.join(tmpdir, 'test.grb'); cdo.topo('r10x10', output=grb, options='-f grb'); info = cdo.sinfon(input=grb); assert 'topo' in str(info).lower(), 'GRIB read failed!'; print('✓ GRIB/ecCodes test passed'); print(cdo.version())"

      - uses: actions/upload-artifact@v6
        with:
          name: wheels-linux-x86_64
          path: ./wheelhouse/*.whl

  # =========================================================================
  # macOS arm64 (Apple Silicon)
  # =========================================================================
  build_macos_arm64:
    name: macOS arm64
    runs-on: macos-14
    timeout-minutes: 90

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install cibuildwheel
        run: pip install cibuildwheel==2.22.0

      - name: Build wheels
        run: python -m cibuildwheel --output-dir wheelhouse
        env:
          CIBW_BUILD: "cp39-macosx_arm64 cp310-macosx_arm64 cp311-macosx_arm64 cp312-macosx_arm64 cp313-macosx_arm64"
          CIBW_BEFORE_ALL_MACOS: >
            sudo mkdir -p /opt/cdo-deps /opt/cdo-install &&
            sudo chown -R $(whoami) /opt/cdo-deps /opt/cdo-install &&
            bash {project}/scripts/build_deps_macos.sh &&
            bash {project}/scripts/build_cdo.sh
          CIBW_ENVIRONMENT_MACOS: >
            SKYBORN_CDO_BUILD=0
            CDO_DEPS_PREFIX=/opt/cdo-deps
            CDO_INSTALL_PREFIX=/opt/cdo-install
            MACOSX_DEPLOYMENT_TARGET=14.0
          CIBW_BEFORE_BUILD_MACOS: >
            mkdir -p {project}/src/skyborn_cdo/bin &&
            cp /opt/cdo-install/bin/cdo {project}/src/skyborn_cdo/bin/ &&
            chmod +x {project}/src/skyborn_cdo/bin/cdo &&
            mkdir -p {project}/src/skyborn_cdo/lib &&
            (cp -a /opt/cdo-deps/lib/*.dylib {project}/src/skyborn_cdo/lib/ 2>/dev/null || true) &&
            (cp -a /opt/cdo-install/lib/*.dylib {project}/src/skyborn_cdo/lib/ 2>/dev/null || true) &&
            mkdir -p {project}/src/skyborn_cdo/share &&
            (cp -r /opt/cdo-deps/share/proj {project}/src/skyborn_cdo/share/ 2>/dev/null || true) &&
            (cp -r /opt/cdo-deps/share/udunits {project}/src/skyborn_cdo/share/ 2>/dev/null || true) &&
            find {project}/src/skyborn_cdo/share/proj/ -type f ! -name 'proj.db' -delete 2>/dev/null || true &&
            strip -x {project}/src/skyborn_cdo/bin/cdo 2>/dev/null || true &&
            find {project}/src/skyborn_cdo/lib/ -name '*.dylib' -exec strip -x {} + 2>/dev/null || true &&
            echo '=== Packaging size check ===' &&
            du -sh {project}/src/skyborn_cdo/bin/ {project}/src/skyborn_cdo/lib/ {project}/src/skyborn_cdo/share/ 2>/dev/null || true &&
            ls -la {project}/src/skyborn_cdo/bin/
          CIBW_REPAIR_WHEEL_COMMAND_MACOS: >
            DYLD_LIBRARY_PATH=/opt/cdo-deps/lib:/opt/cdo-install/lib
            delocate-wheel --require-archs arm64 -w {dest_dir} {wheel}
          CIBW_TEST_COMMAND: >
            python -c "from skyborn_cdo import Cdo; import tempfile, os; cdo = Cdo(); tmpdir = tempfile.mkdtemp(); grb = os.path.join(tmpdir, 'test.grb'); cdo.topo('r10x10', output=grb, options='-f grb'); info = cdo.sinfon(input=grb); assert 'topo' in str(info).lower(), 'GRIB read failed!'; print('✓ GRIB/ecCodes test passed'); print(cdo.version())"

      - uses: actions/upload-artifact@v6
        with:
          name: wheels-macos-arm64
          path: ./wheelhouse/*.whl

  # =========================================================================
  # Windows x86_64 (MSYS2/MinGW64)
  # =========================================================================
  build_windows_x86_64:
    name: Windows x86_64
    runs-on: windows-2022
    timeout-minutes: 120

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-gcc-fortran
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-make
            mingw-w64-x86_64-zlib
            mingw-w64-x86_64-hdf5
            mingw-w64-x86_64-netcdf
            mingw-w64-x86_64-fftw
            mingw-w64-x86_64-proj
            mingw-w64-x86_64-eccodes
            mingw-w64-x86_64-libtool
            mingw-w64-x86_64-autotools
            mingw-w64-x86_64-python
            make
            autoconf
            automake
            libtool
            perl
            wget
            patch

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build CDO dependencies (MSYS2)
        shell: msys2 {0}
        run: |
          export CDO_DEPS_PREFIX=/mingw64
          bash scripts/build_deps_windows.sh

      - name: Build CDO (MSYS2)
        shell: msys2 {0}
        run: |
          export CDO_SOURCE_DIR=$(pwd)/vendor/cdo
          export CDO_DEPS_PREFIX=/mingw64
          export CDO_INSTALL_PREFIX=/opt/cdo-install
          bash scripts/build_cdo_windows.sh

      - name: Prepare CDO binaries for packaging
        shell: msys2 {0}
        run: |
          # Copy CDO binary and its DLL dependencies to package
          mkdir -p src/skyborn_cdo/bin
          cp /opt/cdo-install/bin/cdo.exe src/skyborn_cdo/bin/

          # Copy required MinGW runtime DLLs
          DLLS=$(ldd /opt/cdo-install/bin/cdo.exe | grep mingw64 | awk '{print $3}')
          for dll in $DLLS; do
            cp "$dll" src/skyborn_cdo/bin/
          done

          # Copy data files (eccodes definitions needed on Windows — no MEMFS)
          mkdir -p src/skyborn_cdo/share
          if [ -d /mingw64/share/eccodes ]; then
            cp -r /mingw64/share/eccodes src/skyborn_cdo/share/
          fi
          if [ -d /opt/cdo-install/share/eccodes ]; then
            cp -r /opt/cdo-install/share/eccodes src/skyborn_cdo/share/
          fi
          if [ -d /mingw64/share/proj ]; then
            cp -r /mingw64/share/proj src/skyborn_cdo/share/
          fi
          if [ -d /mingw64/share/udunits ]; then
            cp -r /mingw64/share/udunits src/skyborn_cdo/share/
          fi

          # Strip debug symbols from binaries and DLLs
          strip --strip-unneeded src/skyborn_cdo/bin/cdo.exe 2>/dev/null || true
          find src/skyborn_cdo/bin/ -name '*.dll' -exec strip --strip-unneeded {} + 2>/dev/null || true

          # Trim PROJ data (keep only proj.db)
          find src/skyborn_cdo/share/proj/ -type f ! -name 'proj.db' -delete 2>/dev/null || true

          # Remove eccodes samples/memfs to save space (keep only definitions)
          rm -rf src/skyborn_cdo/share/eccodes/samples 2>/dev/null || true
          rm -rf src/skyborn_cdo/share/eccodes/ifs_samples 2>/dev/null || true

          # Size check
          echo '=== Packaging size check ==='
          du -sh src/skyborn_cdo/bin/ src/skyborn_cdo/share/ 2>/dev/null || true

      - name: Install cibuildwheel
        run: pip install cibuildwheel==2.22.0 delvewheel

      - name: Build wheels
        run: python -m cibuildwheel --output-dir wheelhouse
        env:
          CIBW_BUILD: "cp39-win_amd64 cp310-win_amd64 cp311-win_amd64 cp312-win_amd64 cp313-win_amd64"
          # CDO binaries already copied into package, skip build step
          CIBW_ENVIRONMENT_WINDOWS: >
            SKYBORN_CDO_BUILD=0
          CIBW_REPAIR_WHEEL_COMMAND_WINDOWS: >
            delvewheel repair -w {dest_dir} {wheel}
          CIBW_TEST_COMMAND: >
            python -c "from skyborn_cdo import Cdo; import tempfile, os; cdo = Cdo(); tmpdir = tempfile.mkdtemp(); grb = os.path.join(tmpdir, 'test.grb'); cdo.topo('r10x10', output=grb, options='-f grb'); info = cdo.sinfon(input=grb); assert 'topo' in str(info).lower(), 'GRIB read failed!'; print('✓ GRIB/ecCodes test passed'); print(cdo.version())"

      - uses: actions/upload-artifact@v6
        with:
          name: wheels-windows-x86_64
          path: ./wheelhouse/*.whl

  # =========================================================================
  # Test installation
  # =========================================================================
  test_install:
    name: Test ${{ matrix.os }}
    needs: [build_linux_x86_64, build_macos_arm64, build_windows_x86_64]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-14, windows-latest]
        python-version: ["3.9", "3.10", "3.12"]

    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Install and test
        run: |
          pip install --find-links dist skyborn_cdo
          python -c "from skyborn_cdo import Cdo; cdo = Cdo(); print(repr(cdo)); print(cdo.version())"

  # =========================================================================
  # Publish to PyPI (on tag push)
  # =========================================================================
  # Two authentication methods available:
  # 1. API Token (current): Set PYPI_API_TOKEN in GitHub Secrets
  # 2. Trusted Publisher: Remove password, add "permissions: id-token: write"
  # =========================================================================
  publish:
    name: Publish to PyPI
    needs: [test_install]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
          password: ${{ secrets.PYPI_API_TOKEN }}
